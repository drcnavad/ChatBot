# Company Report Scoring - Fundamental Weight Analysis Documentation

## Overview

This notebook calculates comprehensive fundamental scores for stocks using a multi-factor weighted analysis system. It transforms processed financial metrics into a single `Fundamental_Weight` score ranging from **-10 to +10**, providing a quantitative measure of a stock's fundamental strength.

## Input Data

### Source File

- **`Reports/complete_company_analysis.xlsx`**
  - Sheet: `2_Latest_Quarter_Complete`
  - Contains latest quarter data with all financial ratios and TTM metrics
  - Generated by `company_report_processing.ipynb`

### Required Columns

The notebook requires the following columns from the Excel file:

- **Identifier**: `Symbol`
- **Valuation**: `Price_vs_FairValue`
- **Profitability**: `TTM_ROE`, `TTM_ROA`, `TTM_NetProfitMargin`
- **Growth**: `RevenueGrowth_YoY`
- **Debt**: `Debt_to_Equity`, `DebtToAssets`
- **Efficiency**: `TTM_AssetTurnover`, `TTM_EquityTurnover`
- **Earnings Quality**: `EPSGrowth_YoY`, `NetIncomeGrowth_YoY`
- **Margins**: `TTM_GrossMargin`, `TTM_OperatingMargin`

## Scoring System

### Component Scores (8 Components)

The fundamental analysis uses **8 weighted components** that combine to form the final score:

| Component | Weight | Key Metrics | Score Range |
|-----------|--------|-------------|-------------|
| **Valuation Score** | 25% | Price_vs_FairValue | -5 to +10 |
| **Profitability Score** | 20% | TTM_ROE, TTM_ROA, TTM_NetProfitMargin | -10 to +10 |
| **Growth Score** | 15% | RevenueGrowth_YoY | -5 to +10 |
| **Debt Score** | 15% | Debt_to_Equity, DebtToAssets | -10 to +10 |
| **Earnings Quality Score** | 10% | EPSGrowth_YoY, NetIncomeGrowth_YoY | -10 to +10 |
| **Efficiency Score** | 5% | TTM_AssetTurnover, TTM_EquityTurnover | -10 to +10 |
| **Margin Quality Score** | 5% | TTM_GrossMargin, TTM_OperatingMargin | -10 to +10 |
| **Return Quality Score** | 5% | TTM_ROE, TTM_ROA | -10 to +10 |

**Total Weight**: 100%

### Component Scoring Details

#### 1. Valuation Score (25% weight - Most Important)

Measures if stock is undervalued or overvalued relative to fair value.

**Scoring Logic**:
- `< -20%`: Score **10** (highly undervalued - excellent)
- `< -10%`: Score **7** (undervalued - very good)
- `< 10%`: Score **3** (fairly valued - acceptable)
- `>= 10%`: Score **-5** (overvalued - poor)

**Input**: `Price_vs_FairValue` (percentage difference from fair value, negative = undervalued)

#### 2. Profitability Score (20% weight - Very Important)

Measures profit generation ability using three key metrics.

**Scoring Logic** (combines all three):
- **ROE**:
  - `> 20%`: +4 (excellent)
  - `> 15%`: +3 (very good)
  - `> 10%`: +2 (good)
  - `> 5%`: +1 (acceptable)
  - `< 0%`: -3 (unprofitable)
- **ROA**:
  - `> 10%`: +3 (excellent)
  - `> 5%`: +2 (very good)
  - `> 3%`: +1 (good)
  - `< 0%`: -2 (unprofitable)
- **Net Profit Margin**:
  - `> 20%`: +3 (excellent)
  - `> 10%`: +2 (very good)
  - `> 5%`: +1 (good)
  - `< 0%`: -2 (unprofitable)

**Final Score**: Sum of all three, capped at -10 to +10

**Input**: `TTM_ROE`, `TTM_ROA`, `TTM_NetProfitMargin`

#### 3. Growth Score (15% weight)

Evaluates revenue growth potential.

**Scoring Logic**:
- `> 20%`: Score **10** (exceptional growth)
- `> 10%`: Score **7** (strong growth)
- `> 0%`: Score **3** (positive growth)
- `<= 0%`: Score **-5** (declining revenue - concerning)

**Input**: `RevenueGrowth_YoY` (year-over-year percentage)

#### 4. Debt Score (15% weight)

Assesses financial stability and leverage risk.

**Scoring Logic** (combines both metrics):
- **Debt-to-Equity**:
  - `< 1.0`: +5 (low leverage - excellent)
  - `< 2.0`: +3 (moderate leverage - good)
  - `< 3.0`: +1 (acceptable leverage)
  - `> 5.0`: -5 (high leverage - risky)
  - `3.0-5.0`: -2 (elevated leverage)
- **Debt-to-Assets**:
  - `< 30%`: +5 (low debt - excellent)
  - `< 50%`: +3 (moderate debt - good)
  - `< 70%`: +1 (acceptable debt)
  - `> 85%`: -5 (very high debt - risky)
  - `70-85%`: -2 (high debt)

**Final Score**: Sum of both, capped at -10 to +10

**Input**: `Debt_to_Equity`, `DebtToAssets`

#### 5. Earnings Quality Score (10% weight)

Assesses earnings consistency and quality.

**Scoring Logic** (combines both metrics):
- **EPS Growth**:
  - `> 25%`: +5 (exceptional growth)
  - `> 15%`: +3 (strong growth)
  - `> 5%`: +2 (good growth)
  - `> 0%`: +1 (positive growth)
  - `< -10%`: -5 (significant decline)
  - `-10% to 0%`: -2 (declining)
- **Net Income Growth**: Same thresholds as EPS Growth

**Final Score**: Sum of both, capped at -10 to +10

**Input**: `EPSGrowth_YoY`, `NetIncomeGrowth_YoY`

#### 6. Efficiency Score (5% weight)

Evaluates operational efficiency - capital utilization.

**Scoring Logic** (combines both metrics):
- **Asset Turnover**:
  - `> 1.5`: +5 (highly efficient)
  - `> 1.0`: +3 (efficient)
  - `> 0.5`: +1 (moderate efficiency)
  - `< 0.2`: -3 (inefficient)
  - `0.2-0.5`: -1 (low efficiency)
- **Equity Turnover**:
  - `> 2.0`: +5 (highly efficient)
  - `> 1.0`: +3 (efficient)
  - `> 0.5`: +1 (moderate efficiency)
  - `< 0.2`: -3 (inefficient)
  - `0.2-0.5`: -1 (low efficiency)

**Final Score**: Sum of both, capped at -10 to +10

**Input**: `TTM_AssetTurnover`, `TTM_EquityTurnover`

#### 7. Margin Quality Score (5% weight)

Evaluates pricing power and margin sustainability.

**Scoring Logic** (combines both metrics):
- **Gross Margin**:
  - `> 50%`: +5 (excellent pricing power)
  - `> 40%`: +3 (very good pricing power)
  - `> 30%`: +2 (good pricing power)
  - `> 20%`: +1 (acceptable pricing power)
  - `< 10%`: -3 (low pricing power)
  - `10-20%`: -1 (weak pricing power)
- **Operating Margin**:
  - `> 25%`: +5 (excellent operational efficiency)
  - `> 15%`: +3 (very good operational efficiency)
  - `> 10%`: +2 (good operational efficiency)
  - `> 5%`: +1 (acceptable operational efficiency)
  - `< 0%`: -5 (operating losses)
  - `0-5%`: -2 (low operational efficiency)

**Final Score**: Sum of both, capped at -10 to +10

**Input**: `TTM_GrossMargin`, `TTM_OperatingMargin`

#### 8. Return Quality Score (5% weight)

Measures return sustainability and quality.

**Scoring Logic** (combines both metrics):
- **ROE**:
  - `> 25%`: +5 (exceptional returns)
  - `> 20%`: +4 (excellent returns)
  - `> 15%`: +3 (very good returns)
  - `> 10%`: +2 (good returns)
  - `> 5%`: +1 (acceptable returns)
  - `< 0%`: -4 (negative returns)
  - `0-5%`: -1 (low returns)
- **ROA**: Similar thresholds adjusted for asset-based returns

**Final Score**: Sum of both, capped at -10 to +10

**Input**: `TTM_ROE`, `TTM_ROA`

### Final Score Calculation

#### Weighted Sum

The final `Fundamental_Weight` is calculated as:

```
Fundamental_Weight = (
    Valuation_Score × 0.25 +
    Profitability_Score × 0.20 +
    Growth_Score × 0.15 +
    Debt_Score × 0.15 +
    Earnings_Quality_Score × 0.10 +
    Efficiency_Score × 0.05 +
    Margin_Quality_Score × 0.05 +
    Return_Quality_Score × 0.05
)
```

#### Scaling to -10 to +10 Range

The weighted sum is then scaled using `MinMaxScaler` to ensure the final score falls within the **-10 to +10** range:

- **+10**: Excellent fundamentals (top performers)
- **+5 to +10**: Good fundamentals
- **0 to +5**: Average fundamentals
- **-5 to 0**: Below average fundamentals
- **-10 to -5**: Poor fundamentals

## Output Data

### CSV Export: `Reports/balance_sheet_weights.csv`

Exports complete fundamental analysis including:

#### Exported Columns

1. **Identifier**: `Symbol`
2. **Component Scores** (8 scores):
   - `Valuation_Score`
   - `Profitability_Score`
   - `Growth_Score`
   - `Debt_Score`
   - `Earnings_Quality_Score`
   - `Efficiency_Score`
   - `Margin_Quality_Score`
   - `Return_Quality_Score`
3. **Final Score**: `Fundamental_Weight` (scaled -10 to +10)
4. **Underlying Metrics**: All input metrics used for scoring

### Data Structure

- **Rows**: One per symbol (latest quarter data)
- **Columns**: ~23 columns total
  - 1 identifier column
  - 8 component scores
  - 1 final weight score
  - ~13 underlying fundamental metrics

## Usage

### Score Interpretation

- **Fundamental_Weight > 5**: Strong fundamentals, potential buy signal
- **Fundamental_Weight 2 to 5**: Good fundamentals, consider holding
- **Fundamental_Weight -2 to 2**: Average fundamentals, neutral
- **Fundamental_Weight -5 to -2**: Weak fundamentals, consider selling
- **Fundamental_Weight < -5**: Poor fundamentals, strong sell signal

### Integration

The `Fundamental_Weight` score can be integrated with:
- Technical analysis indicators
- Sentiment analysis scores
- Trading algorithms
- Portfolio optimization systems

## Dependencies

- `pandas`: Data manipulation and CSV export
- `numpy`: Numerical calculations
- `sklearn.preprocessing.MinMaxScaler`: Score scaling to -10 to +10 range
- `openpyxl`: Excel file reading (for input)

## Output File Specifications Summary

### File: `Reports/balance_sheet_weights.csv`

**Purpose**: Store fundamental scores and underlying metrics for each stock

**Columns (23 total, exact order)**:
1. `Symbol` (string, uppercase) - Stock ticker identifier
2. `Valuation_Score` (int, -5 to +10) - Component score
3. `Profitability_Score` (int, -10 to +10) - Component score
4. `Growth_Score` (int, -5 to +10) - Component score
5. `Debt_Score` (int, -10 to +10) - Component score
6. `Earnings_Quality_Score` (int, -10 to +10) - Component score
7. `Efficiency_Score` (int, -10 to +10) - Component score
8. `Margin_Quality_Score` (int, -10 to +10) - Component score
9. `Return_Quality_Score` (int, -10 to +10) - Component score
10. `Fundamental_Weight` (float, -10 to +10) - **Final weighted score (scaled)**
11. `Price_vs_FairValue` (float, percentage) - Underlying metric
12. `RevenueGrowth_YoY` (float, percentage) - Underlying metric
13. `Debt_to_Equity` (float) - Underlying metric
14. `DebtToAssets` (float, percentage) - Underlying metric
15. `TTM_ROE` (float, percentage) - Underlying metric
16. `TTM_ROA` (float, percentage) - Underlying metric
17. `TTM_NetProfitMargin` (float, percentage) - Underlying metric
18. `TTM_AssetTurnover` (float) - Underlying metric
19. `TTM_EquityTurnover` (float) - Underlying metric
20. `EPSGrowth_YoY` (float, percentage) - Underlying metric
21. `NetIncomeGrowth_YoY` (float, percentage) - Underlying metric
22. `TTM_GrossMargin` (float, percentage) - Underlying metric
23. `TTM_OperatingMargin` (float, percentage) - Underlying metric

**Data Requirements**:
- One row per symbol (latest quarter only)
- All component scores must be integers in their respective ranges
- `Fundamental_Weight` must be float scaled to -10 to +10 range
- Missing underlying metrics result in neutral component scores (0)
- Sorted by Symbol

**CRITICAL**: This file is used by `app.py` (Streamlit dashboard) - `Fundamental_Weight` column name must remain consistent!

## Notes for Future API Migration

When adapting this notebook for a different data source (SimFin, FNP, etc.):

### 1. Input Data Structure (CRITICAL)
   **The Excel file `complete_company_analysis.xlsx` Sheet `2_Latest_Quarter_Complete` MUST contain:**
   
   **Required Columns (exact names, case-sensitive):**
   - `Symbol` - Stock ticker (string)
   - `Price_vs_FairValue` - Percentage difference from fair value (float, negative = undervalued)
   - `TTM_ROE` - Trailing Twelve Months Return on Equity (float, percentage)
   - `TTM_ROA` - Trailing Twelve Months Return on Assets (float, percentage)
   - `TTM_NetProfitMargin` - Trailing Twelve Months Net Profit Margin (float, percentage)
   - `RevenueGrowth_YoY` - Year-over-year revenue growth (float, percentage)
   - `Debt_to_Equity` - Debt to equity ratio (float)
   - `DebtToAssets` - Debt to assets ratio (float, percentage)
   - `TTM_AssetTurnover` - Trailing Twelve Months Asset Turnover (float)
   - `TTM_EquityTurnover` - Trailing Twelve Months Equity Turnover (float)
   - `EPSGrowth_YoY` - Year-over-year EPS growth (float, percentage)
   - `NetIncomeGrowth_YoY` - Year-over-year net income growth (float, percentage)
   - `TTM_GrossMargin` - Trailing Twelve Months Gross Margin (float, percentage)
   - `TTM_OperatingMargin` - Trailing Twelve Months Operating Margin (float, percentage)

   **Missing any of these columns will cause scoring to fail!**

### 2. Data Quality Requirements
   - **Latest quarter only**: Sheet must contain only the latest quarter for each symbol (not historical)
   - **One row per symbol**: Each symbol should appear exactly once
   - **Numeric types**: All metric columns must be float64 (not strings)
   - **Missing values**: NaN values are handled (assigned neutral score of 0)

### 3. Score Calculation Requirements
   - **MinMaxScaler**: Uses sklearn's MinMaxScaler to scale final score to -10 to +10 range
   - **Score ranges**: Each component score is capped between -10 and +10 before weighting
   - **Weight sum**: Total weights must equal 100% (currently: 25% + 20% + 15% + 15% + 10% + 5% + 5% + 5% = 100%)

### 4. Output Format Requirements (CRITICAL)
   **CSV file `balance_sheet_weights.csv` must have these columns:**
   ```
   Symbol, Valuation_Score, Profitability_Score, Growth_Score, Debt_Score, 
   Earnings_Quality_Score, Efficiency_Score, Margin_Quality_Score, 
   Return_Quality_Score, Fundamental_Weight, Price_vs_FairValue, 
   RevenueGrowth_YoY, Debt_to_Equity, DebtToAssets, TTM_ROE, TTM_ROA, 
   TTM_NetProfitMargin, TTM_AssetTurnover, TTM_EquityTurnover, 
   EPSGrowth_YoY, NetIncomeGrowth_YoY, TTM_GrossMargin, TTM_OperatingMargin
   ```
   - **Column order**: Should match above (or ensure downstream code can handle different order)
   - **Fundamental_Weight**: Must be scaled to -10 to +10 range (not raw weighted sum)
   - **Data types**: All scores should be float, Symbol should be string

### 5. Score Thresholds
   The scoring thresholds are based on financial research. You may want to:
   - **Sector adjustments**: Adjust thresholds based on sector/industry (tech vs. finance vs. utilities)
   - **Backtesting**: Calibrate weights based on historical performance
   - **Market conditions**: Consider adjusting thresholds for bull vs. bear markets
   - **Customization**: Add sector-specific scoring logic if needed

### 6. Missing Data Handling
   Current logic assigns neutral scores (0) for missing data. Consider:
   - **Imputation**: Fill missing values with sector averages or historical values
   - **Sector defaults**: Use sector-specific default values
   - **Data quality flags**: Add columns to indicate which metrics were missing/imputed
   - **Exclusion**: Optionally exclude symbols with too many missing critical metrics

### 7. Integration Points
   The output CSV (`balance_sheet_weights.csv`) is used by:
   - **`app.py`**: Streamlit dashboard reads `Fundamental_Weight` column
   - **Trading algorithms**: May use `Fundamental_Weight` for buy/sell signals
   - **Other notebooks**: May reference component scores
   - **Column name consistency**: `Fundamental_Weight` column name must remain consistent

### 8. Testing Checklist
   - [ ] Verify Excel file has Sheet `2_Latest_Quarter_Complete`
   - [ ] Verify Sheet 2 has all 14 required columns listed above
   - [ ] Verify column names match exactly (case-sensitive)
   - [ ] Verify data loads without errors
   - [ ] Verify all 8 component scores are calculated (not all 0)
   - [ ] Verify `Fundamental_Weight` is in -10 to +10 range
   - [ ] Verify CSV export has all required columns
   - [ ] Verify CSV can be loaded by `app.py` without errors
