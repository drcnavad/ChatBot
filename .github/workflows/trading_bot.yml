name: Trading Bot Automation

on:
  schedule:
    # 9:30 AM Central Time (14:30 UTC) - Run signal analysis, sell orders, cancel orders, buy orders, git push
    - cron: '30 14 * * 1-5'
    
    # 1:00 PM Central Time (18:00 UTC) - Run signal analysis, sell orders, cancel orders, buy orders, git push
    - cron: '0 18 * * 1-5'
    
    # Other hours: Run signal analysis, then sell orders only
    - cron: '30 15 * * 1-5'  # 10:30 AM CT
    - cron: '30 16 * * 1-5'  # 11:30 AM CT
    - cron: '30 17 * * 1-5'  # 12:30 PM CT
    - cron: '30 18 * * 1-5'  # 1:30 PM CT
    - cron: '0 19 * * 1-5'   # 2:00 PM CT
    - cron: '30 19 * * 1-5'  # 2:30 PM CT
    - cron: '0 20 * * 1-5'   # 3:00 PM CT
  
  workflow_dispatch:  # Allow manual triggering

jobs:
  trading-bot:
    name: Trading Bot Execution
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for git push
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install papermill jupyter
      
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      
      - name: List files for debugging
        run: |
          echo "Current directory: $(pwd)"
          echo "Files in root:"
          ls -la
          echo ""
          echo "Looking for notebook:"
          find . -name "main_signal_analysis.ipynb" -type f 2>/dev/null || echo "Notebook not found"
          echo ""
          echo "Python files:"
          ls -la *.py 2>/dev/null || echo "No .py files in root"
          echo ""
          echo "Checking if notebook exists:"
          test -f main_signal_analysis.ipynb && echo "‚úÖ main_signal_analysis.ipynb exists" || echo "‚ùå main_signal_analysis.ipynb NOT found"
          test -f alpaca_setup.py && echo "‚úÖ alpaca_setup.py exists" || echo "‚ùå alpaca_setup.py NOT found"
      
      - name: Run signal analysis
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        working-directory: ${{ github.workspace }}
        run: |
          echo "üìä Running signal analysis..."
          echo "Working directory: $(pwd)"
          echo "Notebook check:"
          ls -la main_signal_analysis.ipynb 2>&1 || echo "Notebook not in current dir"
          python run_signal_analysis.py || echo "‚ö†Ô∏è Signal analysis failed, but continuing..."
      
      - name: List Python files for debugging
        run: |
          echo "Working directory: $(pwd)"
          echo "Python files in root:"
          ls -la *.py 2>/dev/null || echo "No .py files found"
          echo ""
          echo "Checking for required files:"
          test -f alpaca_setup.py && echo "‚úÖ Found alpaca_setup.py" || echo "‚ùå alpaca_setup.py not found"
          test -f sector_mapping.py && echo "‚úÖ Found sector_mapping.py" || echo "‚ùå sector_mapping.py not found"
          test -f signal_analysis_functions.py && echo "‚úÖ Found signal_analysis_functions.py" || echo "‚ùå signal_analysis_functions.py not found"
          echo ""
          echo "Python path check:"
          python -c "import sys; print('Python path:'); [print(p) for p in sys.path]"
      
      - name: Execute sell orders
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        working-directory: ${{ github.workspace }}
        run: |
          echo "üî¥ Executing sell orders..."
          echo "Working directory: $(pwd)"
          python run_trading_bot.py sell
        continue-on-error: true  # Don't fail workflow if sell orders fail
      
      - name: Check if buy order time
        id: check_buy_time
        run: |
          CURRENT_HOUR=$(date -u +%H)
          CURRENT_MINUTE=$(date -u +%M)
          # 9:30 AM CT = 14:30 UTC, 1:00 PM CT = 18:00 UTC
          if [ "$CURRENT_HOUR" = "14" ] && [ "$CURRENT_MINUTE" = "30" ]; then
            echo "is_buy_time=true" >> $GITHUB_OUTPUT
          elif [ "$CURRENT_HOUR" = "18" ] && [ "$CURRENT_MINUTE" = "00" ]; then
            echo "is_buy_time=true" >> $GITHUB_OUTPUT
          else
            echo "is_buy_time=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Cancel all open orders (before buy)
        if: steps.check_buy_time.outputs.is_buy_time == 'true' || github.event_name == 'workflow_dispatch'
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        working-directory: ${{ github.workspace }}
        run: |
          echo "‚ùå Cancelling all open orders..."
          echo "Working directory: $(pwd)"
          python run_trading_bot.py cancel
      
      - name: Execute buy orders
        if: steps.check_buy_time.outputs.is_buy_time == 'true' || github.event_name == 'workflow_dispatch'
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        working-directory: ${{ github.workspace }}
        run: |
          echo "üü¢ Executing buy orders..."
          echo "Working directory: $(pwd)"
          python run_trading_bot.py buy
      
      - name: Commit and push changes
        if: steps.check_buy_time.outputs.is_buy_time == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          # Only add signal_analysis.csv (output from main_signal_analysis.ipynb)
          # Exclude markdown files and other outputs
          git add Reports/signal_analysis.csv
          
          # Check if there are any changes to commit
          if ! git diff --staged --quiet; then
            git commit -m "Auto-commit: Trading bot executed at $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push
          else
            echo "No changes to commit (signal_analysis.csv unchanged)"
          fi
